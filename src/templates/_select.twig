{% set now = "now"|date("U") %}
{% if name is defined and name %}
    <input type="hidden" name="{{ name }}" value="">
{% endif %}
<div class="multiselect">
    <select style="width: 95%; height: 12rem;" class="{{ name }}_{{ now }}" name="{{ name }}[]" multiple>
        <option value="">{{ "None"|t }}</option>
        {% for option in products %}
            <option value="{{ option.productId }}"{% if option.productId in value %} selected{% endif %}>{{ option.label }} ({{ option.sku }})</option>
        {% endfor %}
    </select>
</div>

{% if filter_class is defined and filter_class %}
    <input style="width: 94%;" placeholder="{{ 'Start typing to filter products ...'|t }}" type="text" class="{{ filter_class }}_{{ now }}" value="">
{% endif %}


<script>
(() => {
    const add_date_class = (element) => {
        const right_now = Date.now();
        if (!/_extra_date_/.test(element.classList)) {
            element.classList.add(`_extra_date_${right_now}`);
        }
    };

    const filter_products = () => {
        let commerce_input = document.querySelector(
            '[class="{{ filter_class }}_{{ now }}"]'
        );
        add_date_class(commerce_input);
        let commerce_select = document.querySelector(
            'select[class="{{ name }}_{{ now }}"]'
        );
        add_date_class(commerce_select);

        commerce_input.addEventListener('input', (event) => {
            if (event.target.value) {
                [...commerce_select.options].forEach((option) => {
                    let regex = new RegExp(event.target.value, 'ig');
                    if (regex.test(option.textContent)) {
                        option.hidden = false;
                    } else {
                        option.hidden = true;
                    }
                });
            } else {
                [...commerce_select.options].forEach((option) => {
                    option.hidden = false;
                });
            }
        });
    };

    filter_products();
    document.addEventListener('DOMContentLoaded', () => {
        filter_products();
    });
})();
</script>

